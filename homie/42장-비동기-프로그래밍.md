# 비동기 프로그래밍

## 동기 처리와 비동기 처리

#### 실행 컨텍스트 개념 알고 가기

- 함수 호출 시 코드가 평가 되어 콜스택에 푸시 되고 함수 코드 실행이 종료 되면 함수 실행 컨텍스트는 스택에서 팝되어 제거 됨
- 함수 코드 평가 과정을 통해 함수 실행 컨텍스트 생성 됨
- 즉, 콜스택에 함수 실행 컨텍스트 푸시 됨 === 함수 실행의 시작을 의미
- 함수의 실행 순서는 실행컨텍스트 스텍으로 관리 됨

#### 동기 처리 방식 이해

- **자바스크립트 엔진은 단 하나의 실행 컨텍스트 스택 갖는다**
- 동시에 2개 이상의 함수를 실행할 수 없다는 것을 의미
- 실행 컨텍스트의 최상위 (실행 중인 함수)를 제외하고 모두 실행 대기 중인 태스크(`Task`)
- 자바 스크립트 엔진은 한 번에 하나의 태스크만 실행할 수 있는 **싱글 스레드**(`single thread`) 방식으로 동작
- 싱글 스레드 방식의 경우 처리에 시간이 걸리는 태스크를 실행 하는 경우 **블로킹**(`blocking`, 작업 중단)

>정리
> 현재 실행 중인 태스크가 종료할 때까지 다음에 실행 될 태스크가 대기하는 방식을 **동기**(`synchronous`) 처리 라고한다.
> 실행 순서 보장되는 장점 있지만 대기 중인 태스크들이 블로킹 되는 단점이 있다.

#### 비동기 처리 방식 이해
- `setTimeout` 함수 경우 비동기 방식으로 동작

```js
function foo() {
  console.log('foo');
}

function bar() {
  console.log('bar');
}

// 타이머 함수 setTimeout은 일정 시간이 경과한 이후에 콜백 함수 foo를 호출한다.
// 타이머 함수 setTimeout은 bar 함수를 블로킹하지 않는다.
setTimeout(foo, 3 * 1000);
bar();
// bar 호출 -> (3초 경과 후) foo 호출
```

- 실행 중인 태스크가 종료 되지 않은 상태라 해도 다음 태스크를 곧바로 실행하는 방식을 **비동기**(`asynchronous`) 처리 라고 한다.
- 동기 처리 방식과 반대로 블로킹 되지 않는 장점, 실행 순서 보장 되지 않는 단점 가짐
- 타이머 함수(`setTimeout`, `setInterval`), `HTTP` 요청, 이벤트 핸들러는 비동기 처리 방식으로 동작

## 이벤트 루프와 태스크 큐
> 벤트 루프는 브라우저에 내장되어 있는 기능
> 자바스크립트는 싱글 스레드 방식으로 동작하지만 이벤트 루프를 통해 동시에 태스크를 처리하는 것처럼 동작 가능

자바스크립트 엔진은 크게 2개의 영역(콜스택, 힙)으로 구분

- **콜 스택**(`call stack`)
	- 소스코드 평가 과정에서 생성된 실행 컨택스트가 추가되거 제거되는 실행 컨텍스트 스택을 말함
	- 자바 스크립트 엔진은 단 하나의 콜스택을 사용
	- 최상위 실행 컨텍스트가 종료되어 콜 스택에서 제거되기 전까지는 어떤 태스크도 실행되지 않는다.

- **힙**(`heap`)
	- 힙은 객체가 저장되는 메모리 공간
	- 콜 스택의 요소인 실행 컨텍스트는 힙에 저장된 객체를 참조
	- 객체는 원시값과 달리 크기가 정해져 있지 않고 런타임에 동적으로 결정
	- 즉, 힙은 구조화 되어 있지 않음

- 즉, 자바스크립트 엔진은 콜 스택 통해 요청된 작업을 순차적으로 실행 할 뿐
- 비동기 처리에서 평가와 실행을 제외한 모든 자리는 브라우저 또는 `nodeJS`에서 담당

이를 위해 브라우저 환경은 태스크 큐와 이벤트 루프를 제공

- **태스크 큐**(`task queue`)
	- 비동기 콜백 함수 또는 이벤트 핸들러가 일시적으로 보관되는 영역
	- 프로미스의 후속 처리 메서드의 콜백 함수가 일시적으로 보관 되는 마이크로 태스크 큐도 존재

- **이벤트 루프**(`event loop`)
	- 이벤트 루프는 콜 스택에서 현재 실행 중인 컨텍스트가 있는지, 태스크 큐에 대기 중인 함수가 있는지 반복해서 확인
	- **콜 스택이 비어있고 태스크 큐에 대기 중인 함수가 있다면 이벤트 루프는  순차적으로 태스크 큐에 대기 중인 함수를 콜 스택으로 이동 시킨다.**

> 정리
> 자바스크립트는 싱글 스레드 방식으로 동작
> 이때 싱글 스레드로 동작하는 것은 브라우저가 아니라 브라우저에 내장된 자바스크립트 엔진
> 자바스크립트 엔진은 싱글 스레드로 동작 하지만 브라우저는 멀티 스레드로 동작




